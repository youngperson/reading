# 问题
1. 幻读是什么
2. 幻读有什么问题
3. 幻读怎么解决
4. 间隙锁的问题

# 幻读是什么
- 查询语句后面带for update表示的是使用当前读，并且加上写锁
- 在可重复读隔离级别下，普通的查询是快照读，是不会看到别的事务插入的数据的。因此，幻读在“当前读”下才会出现
- 当前读的规则，就是要能读到所有已经提交的记录的最新值

# 幻读有什么问题
- 首先是语义上的，我要把所有 d=5 的行锁住，不准别的事务进行读写操作，实际上语义被破坏了
- 数据一致性的问题，锁的设计是为了保证数据的一致性。而这个一致性，不止是数据库内部数据状态在此刻的一致性，还包含了数据和日志在逻辑上的一致性
- 即使把所有的记录都加上锁，还是阻止不了新插入的记录，这也是为什么会出现“幻读”

# 幻读怎么解决
- 产生幻读的原因是，行锁只能锁住行，但是新插入记录这个动作，要更新的是记录之间的“间隙”
- 为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)，间隙锁，锁的就是两个值之间的空隙
- 行锁分为读锁和写锁，行锁下的读锁和读锁之间兼容，其它情况下互斥
- 间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。间隙锁之间都不存在冲突关系

# 间隙锁的问题
- 在可重复读级别下，检索条件必须有索引加锁的时候才可能会使用的是间隙锁
- 间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的