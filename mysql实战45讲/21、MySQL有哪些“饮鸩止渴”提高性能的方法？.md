# 问题
1. 短连接风暴
2. 慢查询性能问题
3. QPS 突增问题

# 短连接风暴
- 正常情况：正常的短连接模式就是连接到数据库后，执行很少的 SQL 语句就断开，下次需要的时候再重连
- 高峰期：使用的是短连接，在业务高峰期的时候，就可能出现连接数突然暴涨的情况
  - MySQL 建立连接的过程，成本是很高的。除了正常的网络连接三次握手外，还需要做登录权限判断和获得这个连接的数据读写权限
  - 短连接模型存在一个风险，就是一旦数据库处理得慢一些，连接数就会暴涨
- max_connections：控制一个 MySQL 实例同时存在的连接数的上限，超过这个值，系统就会拒绝接下来的连接请求
- wait_timeout：一个线程空闲 wait_timeout 这么多秒之后，就会被 MySQL 直接断开连接
- 方案1：从server端先处理掉那些占着连接但是不工作的线程
  - 从服务端断开连接使用的是 kill connection + id 的命令
  - show processlist区分不出哪些是事务外的空闲
  - 查 information_schema 库的 innodb_trx 表，看事务的具体状态
  - 优先断开事务外空闲太久的连接，如果这样还不够，再考虑断开事务内空闲太久的连接
  - 客户端：不要假设所有的应用代码都会被正确地处理。即使只是一个断开连接的操作，也要确保通知到业务开发团队
    - 一个客户端处于 sleep 状态时，它的连接被服务端主动断开后，这个客户端并不会马上知道。直到客户端在发起下一个请求的时候，才会收到这样的报错“ERROR 2013 (HY000): Lost connection to MySQL server during query”
    - 应用端收到这个错误后，不重新连接，而是直接用这个已经不能用的句柄重试查询。这会导致从应用端看上去，“MySQL 一直没恢复”。
- 方案2：减少连接过程的消耗
  - 这是个临时救急的方案，让数据库跳过权限验证阶段
  - 重启数据库，并使用–skip-grant-tables 参数启动。这样，整个 MySQL 会跳过所有的权限验证阶段，包括连接过程和语句执行过程在内
  - 不建议使用的方案。尤其你的库外网可访问的话，就更不能这么做了

# 慢查询性能问题
1. 索引没有设计好
  - 紧急情况：这种场景一般就是通过紧急创建索引来解决。MySQL 5.6 版本以后，创建索引都支持 Online DDL 了。直接执行 alter table 语句
  - 理想情况：比较理想的是能够在备库先执行，然后主备交换。在之前的主库上(现在的备库)执行alter table 语句
  - 平时情况：平时在做变更的时候，你应该考虑类似 gh-ost 这样的方案，更加稳妥
2. SQL语句没写好
  - 改写 SQL 语句来处理。MySQL 5.7 提供了 query_rewrite 功能，可以把输入的一种语句改写成另外一种模式
  - mysql> insert into query_rewrite.rewrite_rules(pattern, replacement, pattern_database) values ("select * from t where id + 1 = ?", "select * from t where id = ? - 1", "db1");
  - call query_rewrite.flush_rewrite_rules();
3. MySQL选错了索引
  - 应急方案就是给这个语句加上 force index
  - 使用查询重写功能，给原来的语句加上 force index
4. 上线前避免1和2
  - 在测试环境，把慢查询日志（slow log）打开，并且把 long_query_time 设置成 0，确保每个语句都会被记录入慢查询日志
  - 在测试表里插入模拟线上的数据，做一遍回归测试
  - 观察慢查询日志里每类语句的输出，特别留意 Rows_examined 字段是否与预期一致

# QPS 突增问题
- 业务突然出现高峰，或者应用程序 bug，导致某个语句的 QPS 突然暴涨，也可能导致 MySQL 压力过大，影响服务
- 由一个新功能的 bug 导致的。当然，最理想的情况是让业务把这个功能下掉，服务自然就会恢复
  - 白名单：假设你的 DB 运维是比较规范的，也就是说白名单是一个个加的。这种情况下，如果你能够确定业务方会下掉这个功能，只是时间上没那么快，那么就可以从数据库端直接把白名单去掉
  - 业务账号分离：新功能使用的是单独的数据库用户，可以用管理员账号把这个用户删掉，然后断开现有连接。这样，这个新功能的连接不成功，由它引发的 QPS 就会变成 0
  - 止血：新增的功能跟主体功能是部署在一起的，那么我们只能通过处理语句来限制。这时，我们可以使用上面提到的查询重写功能，把压力最大的 SQL 语句直接重写成"select 1"
    - 别的功能里面也用到了这个 SQL 语句模板，会有误伤
    - 很多业务并不是靠这一个语句就能完成逻辑的，所以如果单独把这一个语句以 select 1 的结果返回的话，可能会导致后面的业务逻辑一起失败
    - 跟前面提到的去掉权限验证一样，应该是你所有选项里优先级最低的一个方案

